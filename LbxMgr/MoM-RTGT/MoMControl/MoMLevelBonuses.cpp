#include "MoMLevelBonuses.h"

#include <iostream>
#include <vector>

#include "MoMGameBase.h"

namespace MoM {

const uint16_t gOffsetCodeSignature = 0x1D18;

const uint8_t gCodeSignature[] =
{
    0xE9, 0x84, 0x00,
};

const uint8_t gLevelBonusCode[] =
{
    0x55, 0x8B, 0xEC, 0x56, 0x57, 0x8B, 0x7E, 0x06,  0x8B, 0xC7, 0xB1, 0x05, 0xD3, 0xE0, 0xC4, 0x1E, // 0000:
    0xC2, 0x9E, 0x03, 0xD8, 0x26, 0x8A, 0x47, 0x0C,  0x98, 0x8B, 0xF0, 0x8B, 0xC7, 0xB1, 0x05, 0xD3, // 0010:
    0xE0, 0xC4, 0x1E, 0xC2, 0x9E, 0x03, 0xD8, 0x26,  0x8B, 0x47, 0x1A, 0x26, 0x8B, 0x57, 0x18, 0x83, // 0020:
    0xE2, 0x00, 0x25, 0x00, 0x01, 0x0B, 0xD0, 0x75,  0x15, 0xC4, 0x5E, 0x08, 0x26, 0x8B, 0x47, 0x3C, // 0030:
    0x26, 0x8B, 0x57, 0x3A, 0x83, 0xE2, 0x00, 0x25,  0x00, 0x01, 0x0B, 0xD0, 0x74, 0x08, 0x83, 0xFE, // 0040:
    0x03, 0x7D, 0x03, 0xBE, 0x03, 0x00, 0x8B, 0xC7,  0xB1, 0x05, 0xD3, 0xE0, 0xC4, 0x1E, 0xC2, 0x9E, // 0050:
    0x03, 0xD8, 0x26, 0x80, 0x7F, 0x06, 0xFF, 0xE9,  0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0060:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0070:
    0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0080:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,  0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x00, 0x00, // 0090:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x00, 0x00, // 00A0:
    0x01, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 00B0:
    0x00, 0x00, 0x02, 0x02, 0x00, 0x00, 0x02, 0x02,  0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 00C0:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x03, 0x03, 0x00, 0x00, 0x03, 0x02, 0x05, 0x00, // 00D0:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE9, 0xC6, // 00E0:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 00F0:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,  0x01, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, // 0100:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x00, // 0110:
    0x00, 0x01, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0120:
    0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x01,  0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0130:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x04, 0x04, 0x00, 0x00, 0x01, 0x02, 0x04, // 0140:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, // 0150:
    0x05, 0x00, 0x00, 0x02, 0x03, 0x05, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0160:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x00,  0x00, 0x02, 0x03, 0x06, 0x00, 0x00, 0x00, 0x00, // 0170:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, 0x02, // 0180:
    0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0190:
    0x00, 0x08, 0x08, 0x00, 0x00, 0x03, 0x04, 0x08,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 01A0:
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F,  0x05, 0xBB, 0x1B, 0x1D, 0xEB, 0x03, 0xBB, 0xA2, // 01B0:
    0x1D, 0x1E, 0x8B, 0xC6, 0xBA, 0x16, 0x00, 0xF7,  0xEA, 0x03, 0xD8, 0xC4, 0x7E, 0x08, 0x0E, 0x1F, // 01C0:
    0x8B, 0xF3, 0xFC, 0x33, 0xC9, 0x26, 0x8A, 0x1D,  0x80, 0xFB, 0x00, 0x77, 0x09, 0x72, 0x0D, 0x83, // 01D0:
    0xF9, 0x04, 0x74, 0x02, 0xEB, 0x0E, 0xAC, 0x02,  0xC3, 0xAA, 0xEB, 0x0A, 0xAC, 0xF6, 0xD8, 0x02, // 01E0:
    0xC3, 0xAA, 0xEB, 0x02, 0x46, 0x47, 0x41, 0x83,  0xF9, 0x16, 0x7C, 0xD9, 0x1F, 0xE9, 0xBD, 0x00, // 01F0:
};

bool MoMLevelBonuses::isCodeInstalled()
{
    uint8_t* ovl = m_game->getWizardsOverlay(116);
    if (0 == ovl)
        return false;
    uint8_t* codeSignature = &ovl[gOffsetCodeSignature];

    return (0 == memcmp(codeSignature, gCodeSignature, sizeof(gCodeSignature)));
}

bool MoMLevelBonuses::installCode()
{
    uint8_t* ovl = m_game->getWizardsOverlay(116);
    if (0 == ovl)
        return false;
    uint8_t* code = &ovl[0x1CB1];
    std::vector<uint8_t> levelBonusCode(0x1F6E - 0x1CB1, 0x00);
    memcpy(&levelBonusCode[0], gLevelBonusCode, sizeof(gLevelBonusCode));

    std::cout << "Install level bonus code in WIZARDS.EXE" << std::endl;
    bool ok = m_game->commitData(code, &levelBonusCode[0], levelBonusCode.size());
    if (ok)
    {
        std::cout << "Successfully installed level bonus code in WIZARDS.EXE" << std::endl;
    }
    else
    {
        std::cout << "Failed to install level bonus code in WIZARDS.EXE" << std::endl;
    }

    return ok;
}

}
